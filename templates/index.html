<!DOCTYPE html>
<html lang="ru" xmlns="http://www.w3.org/1999/html">
<head>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Приём/передача тягача</title>
    <!-- Bootstrap CSS + JS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <script defer src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"
            crossorigin="anonymous"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

    <link rel="stylesheet" href="./static/style.css">


</head>


<body>
<div class="container">
    <div class="row  mt-4 mb-2">
        <h1 class="col mx-auto text-center h2">Приём/передача тягача.</h1>
    </div>

    {% if result is defined %}
    <div class="result-container">
        <h1>{{ result }}</h1>
    </div>
    {% endif %}


    <button id="btnStart"><i class="fas fa-camera"></i></button>
    <br/>
    <video id="video" autoplay></video>
    <canvas id="canvas" style="display: none;"></canvas>

    <div class="row mt-2 mb-4">
        <div class="col mx-auto">
            <div class="input-group mt-1">
                <select class="form-select bg-warning text-center form__2-7-1__select" name="form__2-7-1__select-1"
                        id="form__2-7-1__select-1" aria-label="form__2-7-1__select-1">
                    <option disabled selected value="null">Выбрать авто...</option>
                    <option value="1">Авто 1</option>
                    <option value="2">Авто 2</option>
                    <option value="3">Авто 3</option>
                </select>
            </div>


            <div class="input-group mt-1">
                <input type="datetime-local" name="form__2-7-1__input-1" id="form__2-7-1__input-1"
                       class="form-control text-center form__2-7-1__input now" required>
            </div>
            <div class="input-group mt-1">
                <select class="form-select text-center form__2-7-1__select" name="form__2-7-1__select-2"
                        id="form__2-7-1__select-2" aria-label="form__2-7-1__select-2">
                    <option disabled selected value="null">Выбрать базу...</option>
                    <option value="База-1">База-1</option>
                    <option value="База-2">База-2</option>
                    <option value="База-3">База-3</option>
                </select>
            </div>
            <div class="input-group mt-1 mb-4">
                <select class="form-select form__2-7-1__select" name="form__2-7-1__select-3"
                        id="form__2-7-1__select-3" aria-label="form__2-7-1__select-3">
                    <option disabled selected value="null">Выбрать колонного...</option>
                    <option value="1">Колонный 1</option>
                    <option value="2">Колонный 2</option>
                    <option value="3">Колонный 3</option>
                </select>
            </div>

            <div class="input-group mt-1">
                <select class="form-select bg-primary text-white form__2-7-1__select" name="form__2-7-1__select-4"
                        id="form__2-7-1__select-4" aria-label="form__2-7-1__select-4">
                    <option disabled selected value="null">Сдает водитель...</option>
                    <option value="водитель1">Грузовой Тягач Прицепович</option>
                    <option value="водитель2">Морозов Дизель Рефрежераторович</option>
                    <option value="водитель3">Третий Водитель Батькович</option>
                </select>
            </div>
            <div class="input-group mt-1">
                <input type="tel" name="form__2-7-1__input-2" id="form__2-7-1__input-2"
                       class="form-control text-center form__2-7-1__input" placeholder="Телефон сдающего водителя">
            </div>

            <div class="card mt-1">
                <div class="card-body">
                    <p class="card-title text-center mb-3">Водитель на осмотре?</p>
                    <div class="d-flex justify-content-around fs-5" role="radiogroup">
                        <div class="form-check form-check-inline">
                            <input type="radio" name="form__2-7-1__radio-g1" id="form__2-7-1__radio-g1-1"
                                   class="form-check-input form__2-7-1__radio" value="Да" required>
                            <label for="form__2-7-1__radio-g1-1"
                                   class="form-check-label d-inline form__2-7-1__label">Да</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input type="radio" name="form__2-7-1__radio-g1" id="form__2-7-1__radio-g1-2"
                                   class="form-check-input form__2-7-1__radio" value="Нет" required>
                            <label for="form__2-7-1__radio-g1-2"
                                   class="form-check-label d-inline form__2-7-1__label">Нет</label>
                        </div>
                    </div>
                </div>
            </div>
            <div class="input-group mt-3">
                <select class="form-select bg-primary text-white form__2-7-1__select" name="form__2-7-1__select-5"
                        id="form__2-7-1__select-5" aria-label="form__2-7-1__select-5">
                    <option disabled selected value="null">Принимает водитель...</option>
                    <option value="водитель1">Грузовой Тягач Прицепович</option>
                    <option value="водитель2">Морозов Дизель Рефрежераторович</option>
                    <option value="водитель3">Третий Водитель Батькович</option>
                </select>
            </div>
            <div class="input-group mt-1">
                <input type="text" name="form__2-7-1__input-3" id="form__2-7-1__input-3"
                       class="form-control text-center form__2-7-1__input"
                       placeholder="Телефон принимающего водителя">
            </div>
            <div class="card mt-1 mb-4">
                <div class="card-body">
                    <p class="card-title text-center mb-3">Водитель на осмотре?</p>
                    <div class="d-flex justify-content-around fs-5" role="radiogroup">
                        <div class="form-check form-check-inline">
                            <input type="radio" name="form__2-7-1__radio-g2" id="form__2-7-1__radio-g2-1"
                                   class="form-check-input form__2-7-1__radio" value="Да" required>
                            <label for="form__2-7-1__radio-g2-1"
                                   class="form-check-label form__2-7-1__label">Да</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input type="radio" name="form__2-7-1__radio-g2" id="form__2-7-1__radio-g2-2"
                                   class="form-check-input form__2-7-1__radio" value="Нет" required>
                            <label for="form__2-7-1__radio-g2-2"
                                   class="form-check-label form__2-7-1__label">Нет</label>
                        </div>
                    </div>
                </div>
            </div>

            <div class="d-grid gap-2 mt-4 mb-3">
                <button type="button" name="form__2-7-1__button-1" id="form__2-7-1__button-1"
                        class="btn btn-outline-primary btn-lg mb-2 form__2-7-1__button" value="Подтверждаю">
                    Подтверждаю
                </button>
                <button type="button" name="form__2-7-1__button-2" id="form__2-7-1__button-2"
                        class="btn btn-primary btn-lg mt-2 form__2-7-1__button"
                        value="Начать приём/передачу тягача">Начать приём/передачу тягача
                </button>
            </div>

            <div class="input-group mt-1">


            </div>
        </div>
    </div>
    <script>


      const video = document.getElementById('video');
      const canvas = document.getElementById('canvas');
      const btnStart = document.getElementById('btnStart');

      // Обработчик клика на кнопке "Начать"
      btnStart.addEventListener('click', () => {
        // Запрашиваем доступ к камере
        navigator.mediaDevices.getUserMedia({ video: true })
          .then((stream) => {
            video.srcObject = stream;
          })
          .catch((error) => {
            console.log('Ошибка при запросе доступа к камере:', error);
          });
      });

      // Обработчик клика внутри видео для сохранения фото на компьютер
      video.addEventListener('click', () => {
        // Устанавливаем размеры canvas такими же, как у видео
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;


          // Рисуем текущий кадр видео на canvas
        canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);

        // Получаем данные снимка в формате base64
        const imageData = canvas.toDataURL('image/jpg'); // Get the base64-encoded image data

        // Отправляем данные снимка на сервер Flask
      $.ajax({
          method: 'POST',
          url: 'save_photo',
          data: JSON.stringify({ image: imageData }),
          contentType: 'application/json',
          success: function(response) {
            console.log('Фото успешно отправлено на сервер');
            // Закрываем окно камеры
                video.srcObject.getTracks().forEach(function(track) {
                  track.stop();
                });
                video.style.display = 'none';
                canvas.style.display = 'none';
                btnStart.disabled = true;
                // Refresh the page
                location.reload();
              },
          error: function(xhr, status, error) {
            console.error('Ошибка при отправке фото:', error);
            console.log('Статус ошибки:', status);
            console.log('Дополнительная информация:', xhr.responseText);
          }
        });
                });



                const date = new Date();
                const twoDigits = (number) => (number < 10) ? '0' + number.toString() : number.toString();
                let valueString = date.getFullYear().toString();
                valueString = valueString.concat('-', twoDigits(date.getMonth()), '-', twoDigits(date.getDate()), 'T', twoDigits(date.getHours()), ':', twoDigits(date.getMinutes()));
                document.querySelectorAll('input[type="datetime-local"].now').forEach((item) => item.value = valueString);



    </script>
</body>
</html>